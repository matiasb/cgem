{% extends 'base.html' %}
{% load qurl %}
{% load static %}

{% block head-extra %}
    <link rel="stylesheet" href="{% static 'css/datepicker3.css' %}" />
    <script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
    <script src="{% static 'js/add-entry.js' %}"></script>
{% endblock head-extra %}

{% block content %}

<div class="row">
  <div class="col-md-12">
    {% for tag in used_tags %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path tag-=tag %}">{{ tag }} &times;</a>
    </div>
    {% endfor %}
    {% if when %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path when-=when %}">{{ when }} &times;</a>
    </div>
    {% endif %}
    {% if year %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path year-=year %}">{{ year }} &times;</a>
    </div>
    {% endif %}
    {% if month %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path month-=month %}">{{ month }} &times;</a>
    </div>
    {% endif %}
    {% if who %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path who-=who %}">{{ who }} &times;</a>
    </div>
    {% endif %}
    {% if country %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path country-=country %}">{{ country }} &times;</a>
    </div>
    {% endif %}
    {% if account %}
    <div class="btn-group">
        <a class="btn btn-xs btn-info close" href="{% qurl request.get_full_path account-=account %}">{{ account }} &times;</a>
    </div>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-md-4">

    <div class="row">
        <h3>Filters</h3>
        <p>{% for tag, i in tags.items %}
            <a class="btn btn-xs btn-info" href="{% qurl request.get_full_path tag+=tag %}">
                {{ tag }} <span class="badge">{{ i }}</span>
            </a>
        {% endfor %}</p>
        <p>{% for k in months %}
            {% ifnotequal k month %}
            <a class="btn btn-xs btn-warning" href="{% qurl request.get_full_path month=k %}">
                {{ k }}
            </a>
            {% endifnotequal %}
        {% endfor %}</p>
        <p>{% for k, i in years.items %}
            {% ifnotequal k year %}
            <a class="btn btn-xs btn-warning" href="{% qurl request.get_full_path year=k %}">
                {{ k }} <span class="badge">{{ i }}</span>
            </a>
            {% endifnotequal %}
        {% endfor %}</p>
        <p>{% for k, i in countries.items %}
            <a class="btn btn-xs btn-success" href="{% qurl request.get_full_path country=k %}">
                {{ k }} <span class="badge">{{ i }}</span>
            </a>
        {% endfor %}</p>
        <p>{% for k, i in users.items %}
            <a class="btn btn-xs btn-success" href="{% qurl request.get_full_path who=k %}">
                {{ k }} <span class="badge">{{ i }}</span>
            </a>
        {% endfor %}</p>
    </div>

    <div class="row">
        <form id="entry-form-search" class="form-horizontal" method="GET" action=".">
            <div class="col-xs-5 has-feedback">
                <input type="text" class="form-control input-sm" name="q" autofocus="on" 
                       id="search-text" placeholder="Search"
                       {% if q %}value="{{ q }}"{% endif %} />
                <span style="cursor: pointer;" id="clear-search-text"
                      class="glyphicon glyphicon-remove form-control-feedback"></span>
            </div>
            <div class="col-xs-5 has-feedback">
                <input type="date" class="form-control input-sm datepicker" name="when"
                       id="search-date" placeholder="When"
                       {% if when %}value="{{ when }}"{% endif %} />
                <span style="cursor: pointer;" id="clear-search-date"
                      class="glyphicon glyphicon-remove form-control-feedback"></span>
            </div>
            <div class="col-xs-2">
                <button class="btn btn-sm btn-default" type="submit">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </div>
        </form>
    </div>

    <div class="row">
        <h3>Balances</h3>
        {% include 'gemcore/_balance_form.html' with form=balance_form btnclass='btn-default' %}
    </div>

    <div class="row">
        <div class="btn-group btn-group-sm vspace-10">
            <a href="{% url 'add-entry' book.slug %}{% qurl . when=when %}" class="btn btn-primary">
                New entry</a>
            <a href="{% url 'account-transfer' book.slug %}" class="btn btn-default">
                Account transfer</a>
            <a href="{% url 'load-from-file' book.slug %}" class="btn btn-default">
                Load from file</a>
        </div>
    </div>

  </div>

<!---------------------------------------------------------------------------->

  <div class="col-md-8">

    <div class="text-center">
    <ul class="pagination pagination-sm">
        {% if entries.has_previous %}
        {% if start > 1 %}
        <li><a href="{% qurl request.get_full_path page=1 %}">&laquo;</a></li>
        {% endif %}
        <li><a href="{% qurl request.get_full_path page=entries.previous_page_number %}">&lsaquo;</a></li>
        {% endif %}
        {% for p in page_range %}
        <li{% ifequal entries.number p %} class="active"{% endifequal %}>
            <a href="{% qurl request.get_full_path page=p %}">{{ p }}</a>
        </li>
        {% endfor %}
        {% if entries.has_next %}
        <li><a href="{% qurl request.get_full_path page=entries.next_page_number %}">&rsaquo;</a></li>
        {% if end < entries.paginator.num_pages %}
        <li><a href="{% qurl request.get_full_path page=entries.paginator.num_pages %}">&raquo;</a></li>
        {% endif %}
        {% endif %}
    </ul>
    </div>

    {% if entries %}
    <table id="entries-list" class="table table-condensed table-hover table-striped">
        <thead>
            <tr>
                <th>When</th>
                <th>Who</th>
                <th>What</th>
                <th>$$$</th>
                <th>From</th>
                <th>Tags</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td>{{ entry.when|date:"d-b" }}</td>
                <td>{{ entry.who.username|slice:"3" }}</td>
                <td>
                    <a href="{% url 'entry' book.slug entry.id %}">{{ entry.what }}</a>
                </td>
                <td class="text-right {% if not entry.is_income %}expense{% endif %}">
                    {% if entry.is_income %}+{% else %}-{% endif %} {{ entry.amount }}
                </td>
                <td>
                    <a href="{% qurl request.get_full_path account=entry.account.slug %}">{{ entry.account }}</a>
                </td>
                <td>
                    {{ entry.country }}<br/>
                    {% for t, is_set in entry.tags %}
                    {% if is_set %}{{ t }}<br/>{% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No entries in the system.</dp>
    {% endif %}

  </div>
</div>

<script>
$("#clear-search-text").click(function(evt) {
    evt.preventDefault();
    $("#search-text").val("").focus();
});
$("#clear-search-date").click(function(evt) {
    evt.preventDefault();
    $("#search-date").val("").focus();
});
</script>

{% endblock content %}
